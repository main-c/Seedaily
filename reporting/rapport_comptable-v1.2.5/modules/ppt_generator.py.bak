#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Module 5: GÃ©nÃ©ration PowerPoint

Ce module gÃ©nÃ¨re la prÃ©sentation PowerPoint finale du rapport comptable.

FonctionnalitÃ©s:
- CrÃ©ation de diapositives Ã  partir des donnÃ©es Excel
- IntÃ©gration des commentaires du Module 4
- GÃ©nÃ©ration de tableaux et graphiques
- Mise en forme professionnelle
- Utilisation du modÃ¨le PPT existant comme rÃ©fÃ©rence
"""

from pptx import Presentation
from pptx.util import Inches, Pt, Cm
from pptx.enum.text import PP_ALIGN, MSO_ANCHOR, MSO_AUTO_SIZE
from pptx.dml.color import RGBColor
from pptx.chart.data import CategoryChartData
from pptx.enum.chart import XL_CHART_TYPE, XL_LEGEND_POSITION
import openpyxl
import pandas as pd
import logging
from pathlib import Path
from typing import Dict, Optional, List, Tuple
from datetime import datetime

logger = logging.getLogger(__name__)


def generate_powerpoint(excel_path: str, output_path: str, commentaires: Optional[Dict] = None,
                       template_path: Optional[str] = None):
    """
    GÃ©nÃ¨re le rapport PowerPoint final complet

    Args:
        excel_path: Chemin vers le fichier Excel gÃ©nÃ©rÃ©
        output_path: Chemin de sortie du PowerPoint
        commentaires: Dictionnaire avec les commentaires (du Module 4)
        template_path: Chemin vers le template PowerPoint (optionnel)
    """
    logger.info("=" * 80)
    logger.info("GÃ‰NÃ‰RATION DU RAPPORT POWERPOINT")
    logger.info("=" * 80)
    logger.info(f"Fichier Excel source: {excel_path}")
    logger.info(f"Fichier PowerPoint cible: {output_path}")

    try:
        # Charger les donnÃ©es Excel
        logger.info("Chargement des donnÃ©es Excel...")
        excel_data = load_excel_data(excel_path)

        # CrÃ©er une nouvelle prÃ©sentation
        logger.info("CrÃ©ation de la prÃ©sentation...")
        prs = Presentation()
        prs.slide_width = Inches(10)
        prs.slide_height = Inches(7.5)

        # Extraire les informations
        periode = commentaires.get('periode', 'Septembre 2025') if commentaires else 'Septembre 2025'
        cabinet = commentaires.get('cabinet', '2BN CONSULTING') if commentaires else '2BN CONSULTING'
        client = commentaires.get('client', 'BAMBOO IMMO') if commentaires else 'BAMBOO IMMO'

        # 1. Diapositive de titre
        logger.info("CrÃ©ation de la diapositive de titre...")
        add_title_slide(prs, cabinet, client, periode)

        # 2. Diapositive Bilan
        logger.info("CrÃ©ation de la diapositive Bilan...")
        bilan_comment = commentaires.get('bilan', {}).get('commentaire', '') if commentaires else ''
        add_bilan_slide(prs, excel_data, bilan_comment)

        # 3. Diapositive Compte de RÃ©sultat
        logger.info("CrÃ©ation de la diapositive Compte de RÃ©sultat...")
        cr_comment = commentaires.get('compte_resultat', {}).get('commentaire', '') if commentaires else ''
        add_compte_resultat_slide(prs, excel_data, cr_comment)

        # 4. Diapositive SIG
        logger.info("CrÃ©ation de la diapositive SIG...")
        sig_comment = commentaires.get('sig', {}).get('commentaire', '') if commentaires else ''
        add_sig_slide(prs, excel_data, sig_comment)

        # 5. Diapositive Suivi d'ActivitÃ©
        logger.info("CrÃ©ation de la diapositive Suivi d'ActivitÃ©...")
        suivi_comment = commentaires.get('suivi_activite', {}).get('commentaire', '') if commentaires else ''
        add_suivi_activite_slide(prs, excel_data, suivi_comment)

        # 6. Diapositive SynthÃ¨se
        logger.info("CrÃ©ation de la diapositive SynthÃ¨se...")
        synthese_comment = commentaires.get('synthese', {}).get('commentaire', '') if commentaires else ''
        add_synthese_slide(prs, synthese_comment)

        # Sauvegarder la prÃ©sentation
        logger.info(f"Sauvegarde de la prÃ©sentation: {output_path}")
        prs.save(output_path)

        logger.info("=" * 80)
        logger.info(f"âœ… Rapport PowerPoint gÃ©nÃ©rÃ© avec succÃ¨s!")
        logger.info(f"ğŸ“„ Fichier: {output_path}")
        logger.info(f"ğŸ“Š Nombre de diapositives: {len(prs.slides)}")
        logger.info("=" * 80)

    except Exception as e:
        logger.error(f"âŒ Erreur lors de la gÃ©nÃ©ration du PowerPoint: {e}", exc_info=True)
        raise


def load_excel_data(excel_path: str) -> Dict:
    """
    Charge les donnÃ©es depuis le fichier Excel gÃ©nÃ©rÃ©

    Args:
        excel_path: Chemin vers le fichier Excel

    Returns:
        Dictionnaire contenant les donnÃ©es de toutes les feuilles
    """
    try:
        wb = openpyxl.load_workbook(excel_path)
        data = {}

        # Charger les donnÃ©es de chaque feuille
        for sheet_name in wb.sheetnames:
            ws = wb[sheet_name]
            sheet_data = []

            for row in ws.iter_rows(values_only=True):
                sheet_data.append(row)

            data[sheet_name] = sheet_data

        logger.info(f"DonnÃ©es chargÃ©es depuis {len(data)} feuilles")
        return data

    except Exception as e:
        logger.error(f"Erreur lors du chargement du fichier Excel: {e}")
        raise


def add_title_slide(prs: Presentation, cabinet: str, client: str, periode: str):
    """
    Ajoute la diapositive de titre

    Args:
        prs: Objet Presentation
        cabinet: Nom du cabinet
        client: Nom du client
        periode: PÃ©riode du rapport
    """
    slide = prs.slides.add_slide(prs.slide_layouts[6])  # Blank layout

    # Fond bleu
    background = slide.background
    fill = background.fill
    fill.solid()
    fill.fore_color.rgb = RGBColor(54, 96, 146)  # Bleu professionnel

    # Titre principal
    left = Inches(1)
    top = Inches(2)
    width = Inches(8)
    height = Inches(1.5)
    textbox = slide.shapes.add_textbox(left, top, width, height)
    text_frame = textbox.text_frame
    text_frame.text = "RAPPORT COMPTABLE"
    p = text_frame.paragraphs[0]
    p.alignment = PP_ALIGN.CENTER
    p.font.bold = True
    p.font.size = Pt(44)
    p.font.color.rgb = RGBColor(255, 255, 255)

    # Client
    top = Inches(3.7)
    height = Inches(1)
    textbox = slide.shapes.add_textbox(left, top, width, height)
    text_frame = textbox.text_frame
    text_frame.text = client
    p = text_frame.paragraphs[0]
    p.alignment = PP_ALIGN.CENTER
    p.font.bold = True
    p.font.size = Pt(36)
    p.font.color.rgb = RGBColor(255, 255, 255)

    # PÃ©riode
    top = Inches(5)
    height = Inches(0.8)
    textbox = slide.shapes.add_textbox(left, top, width, height)
    text_frame = textbox.text_frame
    text_frame.text = periode
    p = text_frame.paragraphs[0]
    p.alignment = PP_ALIGN.CENTER
    p.font.size = Pt(28)
    p.font.color.rgb = RGBColor(255, 255, 255)

    # Cabinet (en bas)
    top = Inches(6.5)
    height = Inches(0.5)
    textbox = slide.shapes.add_textbox(left, top, width, height)
    text_frame = textbox.text_frame
    text_frame.text = cabinet
    p = text_frame.paragraphs[0]
    p.alignment = PP_ALIGN.CENTER
    p.font.size = Pt(18)
    p.font.color.rgb = RGBColor(200, 200, 200)


def update_dates(prs: Presentation, date: str):
    """
    Met Ã  jour les dates sur les slides

    Args:
        prs: Objet Presentation
        date: Date au format DD/MM/YYYY
    """
    logger.info(f"Mise Ã  jour de la date: {date}")

    try:
        # Slide 1 (index 0): Page de garde
        if len(prs.slides) > 0:
            slide = prs.slides[0]
            for shape in slide.shapes:
                if hasattr(shape, "text") and "date" in shape.text.lower():
                    shape.text = shape.text.replace("{{DATE}}", date)
                    # Chercher aussi d'autres patterns
                    if "202" in shape.text or "201" in shape.text:
                        # Remplacer les anciennes dates
                        import re
                        shape.text = re.sub(r'\d{2}/\d{2}/\d{4}', date, shape.text)

        # Slide 2 (index 1): Sommaire
        if len(prs.slides) > 1:
            slide = prs.slides[1]
            for shape in slide.shapes:
                if hasattr(shape, "text") and ("date" in shape.text.lower() or "202" in shape.text):
                    import re
                    shape.text = re.sub(r'\d{2}/\d{2}/\d{4}', date, shape.text)

        logger.info("Dates mises Ã  jour")

    except Exception as e:
        logger.warning(f"Erreur lors de la mise Ã  jour des dates: {e}")


def insert_evenements(prs: Presentation, evenements: str, slide_index: int = 3):
    """
    InsÃ¨re les Ã©vÃ©nements significatifs

    Args:
        prs: Objet Presentation
        evenements: Texte des Ã©vÃ©nements
        slide_index: Index de la slide (dÃ©faut: 3)
    """
    logger.info("Insertion des Ã©vÃ©nements significatifs")

    try:
        if len(prs.slides) > slide_index:
            slide = prs.slides[slide_index]

            # Chercher une zone de texte existante ou en crÃ©er une
            text_frame = None

            # Chercher un placeholder de contenu
            for shape in slide.shapes:
                if shape.has_text_frame and not shape.text.strip() == slide.shapes.title.text:
                    text_frame = shape.text_frame
                    break

            # Si pas trouvÃ©, crÃ©er une nouvelle zone de texte
            if text_frame is None:
                left = Inches(1)
                top = Inches(2)
                width = Inches(8)
                height = Inches(4)
                textbox = slide.shapes.add_textbox(left, top, width, height)
                text_frame = textbox.text_frame

            # InsÃ©rer le texte
            text_frame.clear()
            text_frame.text = evenements if evenements else "Aucun Ã©vÃ©nement significatif Ã  signaler."
            text_frame.word_wrap = True

            # Style du texte
            for paragraph in text_frame.paragraphs:
                paragraph.font.size = Pt(14)

            logger.info("Ã‰vÃ©nements insÃ©rÃ©s")

        else:
            logger.warning(f"Slide {slide_index} non trouvÃ©e")

    except Exception as e:
        logger.warning(f"Erreur lors de l'insertion des Ã©vÃ©nements: {e}")


def insert_commentaires(prs: Presentation, commentaires: str, slide_index: int = -1):
    """
    InsÃ¨re les commentaires de conclusion

    Args:
        prs: Objet Presentation
        commentaires: Texte des commentaires
        slide_index: Index de la slide (dÃ©faut: derniÃ¨re slide ou slide 11)
    """
    logger.info("Insertion des commentaires de conclusion")

    try:
        # DÃ©terminer l'index de la slide
        if slide_index == -1:
            # Chercher la slide de commentaires (gÃ©nÃ©ralement index 11)
            target_index = min(11, len(prs.slides) - 1) if len(prs.slides) > 11 else len(prs.slides) - 1
        else:
            target_index = slide_index

        if len(prs.slides) > target_index:
            slide = prs.slides[target_index]

            # Chercher une zone de texte existante ou en crÃ©er une
            text_frame = None

            for shape in slide.shapes:
                if shape.has_text_frame and not shape.text.strip() == slide.shapes.title.text:
                    text_frame = shape.text_frame
                    break

            # Si pas trouvÃ©, crÃ©er une nouvelle zone de texte
            if text_frame is None:
                left = Inches(1)
                top = Inches(2)
                width = Inches(8)
                height = Inches(4)
                textbox = slide.shapes.add_textbox(left, top, width, height)
                text_frame = textbox.text_frame

            # InsÃ©rer le texte
            text_frame.clear()
            text_frame.text = commentaires if commentaires else "Aucun commentaire particulier."
            text_frame.word_wrap = True

            # Style du texte
            for paragraph in text_frame.paragraphs:
                paragraph.font.size = Pt(14)

            logger.info("Commentaires insÃ©rÃ©s")

        else:
            logger.warning(f"Slide {target_index} non trouvÃ©e")

    except Exception as e:
        logger.warning(f"Erreur lors de l'insertion des commentaires: {e}")


def insert_text(prs: Presentation, slide_idx: int, text: str, placeholder_idx: int = 1):
    """
    InsÃ¨re du texte sur une slide spÃ©cifique

    Args:
        prs: Objet Presentation
        slide_idx: Index de la slide
        text: Texte Ã  insÃ©rer
        placeholder_idx: Index du placeholder (dÃ©faut: 1)
    """
    if len(prs.slides) > slide_idx:
        slide = prs.slides[slide_idx]

        if len(slide.placeholders) > placeholder_idx:
            placeholder = slide.placeholders[placeholder_idx]
            placeholder.text = text
            logger.debug(f"Texte insÃ©rÃ© sur slide {slide_idx}")
        else:
            logger.warning(f"Placeholder {placeholder_idx} non trouvÃ© sur slide {slide_idx}")
    else:
        logger.warning(f"Slide {slide_idx} non trouvÃ©e")


def save_presentation(prs: Presentation, output_path: str):
    """
    Sauvegarde la prÃ©sentation PowerPoint

    Args:
        prs: Objet Presentation
        output_path: Chemin de sortie
    """
    logger.info(f"Sauvegarde de la prÃ©sentation: {output_path}")

    try:
        prs.save(output_path)
        logger.info("PrÃ©sentation sauvegardÃ©e avec succÃ¨s")

    except Exception as e:
        logger.error(f"Erreur lors de la sauvegarde: {e}")
        raise PowerPointGenerationError(f"Impossible de sauvegarder la prÃ©sentation: {e}")


# Note: Les fonctions suivantes nÃ©cessitent Excel installÃ© pour convertir les tableaux en images
# Elles sont laissÃ©es en commentaire pour une implÃ©mentation future

"""
def excel_to_image(excel_path: str, sheet: str, cell_range: str) -> Image:
    '''
    Convertit une plage Excel en image PNG

    NÃ©cessite: win32com (Windows) ou LibreOffice (Linux/Mac)
    '''
    # TODO: ImplÃ©menter la conversion Excel vers image
    pass

def insert_image(prs: Presentation, slide_idx: int, image_path: str,
                 left: float = 1, top: float = 2, width: float = 8):
    '''
    InsÃ¨re une image sur une slide
    '''
    if len(prs.slides) > slide_idx:
        slide = prs.slides[slide_idx]
        slide.shapes.add_picture(
            image_path,
            Inches(left),
            Inches(top),
            width=Inches(width)
        )
        logger.debug(f"Image insÃ©rÃ©e sur slide {slide_idx}")
"""
